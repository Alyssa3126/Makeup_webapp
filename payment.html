<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Payment Options</title>
<style>
  body { background:#f28bb8; font-family:Arial, sans-serif; display:flex; align-items:center; justify-content:center; height:100vh; margin:0; }
  .card { background:#fff; width:460px; padding:22px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.15) }
  h2{ text-align:center; margin:0 0 8px }
  .small{ color:#666; font-size:14px; text-align:center; margin-bottom:12px }
  .summary{ background:#f7f7f9; padding:10px; border-radius:8px; margin-bottom:12px; font-size:14px }
  label{ display:block; margin-top:10px; font-weight:600 }
  input, select{ width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #ddd; box-sizing:border-box }
  .payment-methods{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap }
  .payment-methods button{ flex:1; padding:10px; border-radius:8px; border:none; cursor:pointer; background:#eee }
  .payment-methods button.selected{ background:#1a73e8; color:#fff }
  .method-fields{ margin-top:12px }
  .actions{ display:flex; gap:8px; margin-top:14px }
  .btn-primary{ flex:1; background:#1a73e8; color:#fff; padding:12px; border:none; border-radius:8px; cursor:pointer }
  .btn-light{ flex:1; background:#eee; border:none; border-radius:8px; cursor:pointer }
  .hint{ font-size:12px; color:#666; margin-top:6px }
</style>
</head>
<body>
  <div class="card">
    <h2>Payment Options</h2>
    <div class="small">Review order & choose a payment method</div>

    <div id="orderSummary" class="summary">
      <!-- injected by JS -->
    </div>

    <div>
      <label>Select method</label>
      <div class="payment-methods" role="tablist">
        <button type="button" data-method="upi" id="m-upi">UPI</button>
        <button type="button" data-method="card" id="m-card">Card</button>
        <button type="button" data-method="cod" id="m-cod">Cash on Delivery</button>
      </div>

      <div class="method-fields" id="methodFields">
        <!-- dynamic fields go here -->
      </div>

      <div class="actions">
        <button class="btn-light" id="backBtn">← Back</button>
        <button class="btn-primary" id="payNow">Pay Now</button>
      </div>
      <div class="hint">This is a demo payment page — no real money will be charged.</div>
    </div>
  </div>

<script>
// Load order details from sessionStorage
const name = sessionStorage.getItem('order_name') || '';
const address = sessionStorage.getItem('order_address') || '';
const phone = sessionStorage.getItem('order_phone') || '';

if (!name || !address || !phone) {
  alert('No order found — please fill checkout first.');
  window.location.href = 'orders.html';
}

// Show order summary safely
document.getElementById('orderSummary').innerHTML =
  `<strong>${escapeHtml(name)}</strong><br>${escapeHtml(address)}<br><em>${escapeHtml(phone)}</em>`;

function escapeHtml(s) {
  return s.replace(/[&<>'"]/g, c => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    "'": '&#39;',
    '"': '&quot;'
  }[c]));
}

// Payment method selection logic
let currentMethod = 'upi';
const buttons = document.querySelectorAll('.payment-methods button');
buttons.forEach(btn => {
  btn.addEventListener('click', () => {
    buttons.forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    currentMethod = btn.dataset.method;
    renderFields(currentMethod);
  });
});

// Default: select first method
document.getElementById('m-upi').classList.add('selected');
renderFields('upi');

function renderFields(method) {
  const container = document.getElementById('methodFields');
  container.innerHTML = '';

  if (method === 'upi') {
    container.innerHTML = `
      <label for="upiId">UPI ID</label>
      <input id="upiId" placeholder="example@upi" />
      <label for="upiNote">Note (optional)</label>
      <input id="upiNote" placeholder="Order #1234" />
    `;
  } else if (method === 'card') {
    container.innerHTML = `
      <label for="cardNumber">Card Number</label>
      <input id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" />
      <label style="display:flex; gap:8px">
        <input id="expiry" placeholder="MM/YY" style="flex:1" />
        <input id="cvv" placeholder="CVV" style="flex:1" maxlength="4" />
      </label>
      <label for="cardName">Name on Card</label>
      <input id="cardName" placeholder="${escapeHtml(name)}" />
    `;
  } else if (method === 'cod') {
    // ✅ FIXED: added backticks to make this valid JS
    container.innerHTML = `
      <div style="padding:10px;background:#f7f7f9;border-radius:8px">
        You selected <strong>Cash on Delivery</strong>.
        Please have the exact amount ready on delivery.
      </div>
    `;
  }
}

// Back button → Go back to Orders page
document.getElementById('backBtn').addEventListener('click', () => {
  window.location.href = 'orders.html';
});

// Pay Now button → Validate + Go to Confirmation
document.getElementById('payNow').addEventListener('click', () => {
  if (currentMethod === 'upi') {
    const upiId = (document.getElementById('upiId') || {}).value || '';
    if (!/^[\w.\-]+@[\w]+$/.test(upiId)) {
      alert('Enter a valid UPI ID like alice@bank');
      return;
    }
    sessionStorage.setItem('payment_method', 'UPI');
    sessionStorage.setItem('payment_details', JSON.stringify({ upiId }));
  } else if (currentMethod === 'card') {
    const card = (document.getElementById('cardNumber') || {}).value.replace(/\s+/g, '');
    const cvv = (document.getElementById('cvv') || {}).value;
    const expiry = (document.getElementById('expiry') || {}).value;
    const cardName = (document.getElementById('cardName') || {}).value || name;

    if (!/^\d{12,19}$/.test(card)) { alert('Enter a plausible card number (digits only)'); return; }
    if (!/^\d{3,4}$/.test(cvv)) { alert('Enter a valid CVV'); return; }
    if (!/^\d{2}\/\d{2}$/.test(expiry)) { alert('Expiry should be MM/YY'); return; }

    const masked = '* * ** ' + card.slice(-4);
    sessionStorage.setItem('payment_method', 'Card');
    sessionStorage.setItem('payment_details', JSON.stringify({ card: masked, cardName, expiry }));
  } else if (currentMethod === 'cod') {
    sessionStorage.setItem('payment_method', 'Cash on Delivery');
    sessionStorage.setItem('payment_details', JSON.stringify({ note: 'Pay on delivery' }));
  }

  // Show loading message and redirect
  const payBtn = document.getElementById('payNow');
  payBtn.innerText = 'Processing...';
  payBtn.disabled = true;

  setTimeout(() => {
    window.location.href = 'confirmation.html';
  }, 700);
});

// Debugging check — optional
console.log("Pay Now button found:", document.getElementById("payNow"));
</script>
</body>
</html>